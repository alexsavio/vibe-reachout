# Data Model: Telegram Permission Hook

## Entities

### Config

User configuration loaded from `~/.config/vibe-reachout/config.toml`.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `telegram_bot_token` | String | yes | — | Telegram Bot API token |
| `allowed_chat_ids` | Vec\<i64\> | yes | — | Authorized Telegram chat IDs (single owner, multiple devices) |
| `timeout_seconds` | u64 | no | 300 | Seconds before hook falls back to terminal |
| `socket_path` | PathBuf | no | platform-dependent | Unix socket path override |

**Validation rules**:
- `telegram_bot_token` must be non-empty
- `allowed_chat_ids` must have at least one entry
- `timeout_seconds` must be > 0 and <= 3600
- `socket_path` parent directory must exist

### HookInput

JSON received on stdin from Claude Code when PermissionRequest fires.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session_id` | String | yes | Claude Code session identifier |
| `transcript_path` | String | yes | Path to conversation JSONL file |
| `cwd` | String | yes | Current working directory |
| `permission_mode` | String | yes | "default", "plan", "acceptEdits", "dontAsk", "bypassPermissions" |
| `hook_event_name` | String | yes | Always "PermissionRequest" |
| `tool_name` | String | yes | Tool being called (Bash, Write, Edit, etc.) |
| `tool_input` | Object | yes | Tool-specific parameters (varies by tool) |
| `permission_suggestions` | Array | no | Always-allow options (may be empty/absent) |

**tool_input shapes by tool_name**:
- `Bash`: `{ command: String, description?: String, timeout?: u64 }`
- `Write`: `{ file_path: String, content: String }`
- `Edit`: `{ file_path: String, old_string: String, new_string: String }`
- `Read`: `{ file_path: String, offset?: u64, limit?: u64 }`
- `Task`: `{ prompt: String, description: String, subagent_type: String }`
- MCP tools (`mcp__*`): variable

### HookOutput

JSON written to stdout for Claude Code.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `hookSpecificOutput` | Object | yes | Wrapper object |
| `hookSpecificOutput.hookEventName` | String | yes | "PermissionRequest" |
| `hookSpecificOutput.decision` | Object | yes | Decision details |
| `hookSpecificOutput.decision.behavior` | String | yes | "allow" or "deny" |
| `hookSpecificOutput.decision.message` | String | no | Denial reason (deny only) — also used to carry user's free-text reply |
| `hookSpecificOutput.decision.updatedPermissions` | Array | no | Always-allow rules (allow only) |
| `hookSpecificOutput.decision.updatedInput` | Object | no | Modified tool input (allow only, deferred) |

**State transitions** (hook process):
```
Start → ReadStdin → ConnectSocket → SendIpcRequest → WaitForResponse → WriteStdout → Exit(0)
                   ↓ (socket not found)         ↓ (timeout)
                   Exit(1)                       Exit(1)
```

### IpcRequest

Newline-delimited JSON sent from hook process to bot over Unix socket.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `request_id` | UUID v4 | yes | Unique identifier for correlation |
| `tool_name` | String | yes | From HookInput |
| `tool_input` | Object | yes | From HookInput |
| `cwd` | String | yes | From HookInput |
| `session_id` | String | yes | From HookInput |
| `permission_suggestions` | Array | no | From HookInput |

**Identity/uniqueness**: `request_id` is generated by the hook process (UUID v4), globally unique.

### IpcResponse

Newline-delimited JSON sent from bot to hook over Unix socket.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `request_id` | UUID v4 | yes | Matches the IpcRequest |
| `decision` | Enum | yes | Allow, Deny, AlwaysAllow, Reply, Timeout |
| `message` | String | no | Denial reason or context |
| `user_message` | String | no | Free-text from user's Reply action |
| `always_allow_suggestion` | Object | no | Permission suggestion to apply |

**Decision enum values**:
- `Allow` → HookOutput behavior "allow"
- `Deny` → HookOutput behavior "deny" with message
- `AlwaysAllow` → HookOutput behavior "allow" with updatedPermissions
- `Reply` → HookOutput behavior "deny" with user_message in message field (Claude reads it as feedback)
- `Timeout` → Hook exits code 1 (terminal fallback)

### PendingRequest (runtime, not persisted)

In-memory state for a request awaiting Telegram response.

| Field | Type | Description |
|-------|------|-------------|
| `request_id` | UUID v4 | Correlation key |
| `sender` | oneshot::Sender\<IpcResponse\> | Channel to resolve the waiting hook |
| `sent_messages` | Vec\<SentMessage\> | All Telegram messages sent for this request (one per authorized chat) |
| `original_text` | String | Original message text (for editing) |
| `permission_suggestions` | Vec\<Value\> | For always-allow button |
| `created_at` | Instant | For timeout tracking |

### SentMessage (runtime, not persisted)

Tracks each Telegram message sent per authorized chat for a single request.

| Field | Type | Description |
|-------|------|-------------|
| `chat_id` | ChatId | Telegram chat where message was sent |
| `message_id` | MessageId | Telegram message ID for editing |

### ReplyState (runtime, not persisted)

Tracks active Reply flows. Maps a chat_id to the request_id awaiting a free-text reply.

| Field | Type | Description |
|-------|------|-------------|
| Key: `chat_id` | ChatId | Telegram chat where ForceReply was sent |
| Value: `request_id` | UUID v4 | The pending request awaiting reply text |

Stored as `DashMap<ChatId, Uuid>`. Entry is added when user taps Reply, removed when reply text is received or request times out.

## Relationships

```
HookInput (stdin) → [hook process] → IpcRequest (socket) → [bot process] → Telegram message
                                                                              ↓ (callback)
HookOutput (stdout) ← [hook process] ← IpcResponse (socket) ← [bot process] ← User tap
```

- One HookInput maps to exactly one IpcRequest (1:1)
- One IpcRequest maps to exactly one PendingRequest (1:1)
- One PendingRequest maps to one or more Telegram messages (1:N, one per authorized chat_id)
- One Telegram message resolves to exactly one IpcResponse (1:1)
- One IpcResponse maps to exactly one HookOutput (1:1)

## State Machine: PendingRequest Lifecycle

```
Created → Pending → Resolved(Allow|Deny|AlwaysAllow|Reply) → Cleaned up
                  ↘ TimedOut → Cleaned up
```

- **Created**: Hook connects, sends IpcRequest, bot creates PendingRequest
- **Pending**: Telegram message sent, awaiting user interaction
- **Resolved**: User tapped a button or sent reply text; oneshot channel fires
- **TimedOut**: timeout_seconds elapsed; hook exits code 1, bot edits message to "Timed out"
- **Cleaned up**: Entry removed from DashMap

Late callbacks (after Resolved or TimedOut) are answered with "This request has already been handled."
